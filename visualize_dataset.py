import argparse
import os

import matplotlib.pyplot as plt
import pandas as pd


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description="Visualize dataset distribution and sample images."
    )
    parser.add_argument(
        "--train-csv",
        default="data_clean/train.csv",
        help="Path to train.csv generated by preprocess.py",
    )
    parser.add_argument(
        "--images-dir",
        default="data_clean/images",
        help="Directory containing resized images",
    )
    parser.add_argument(
        "--output-dir",
        default="artifacts",
        help="Directory to save plots",
    )
    parser.add_argument(
        "--samples-per-class",
        type=int,
        default=3,
        help="Number of sample images per class",
    )
    return parser.parse_args()


def main() -> None:
    args = parse_args()

    if os.path.isfile("data_clean") and args.train_csv.startswith("data_clean/"):
        args.train_csv = args.train_csv.replace("data_clean/", "data_clean_dir/")
        args.images_dir = args.images_dir.replace("data_clean/", "data_clean_dir/")

    os.makedirs(args.output_dir, exist_ok=True)

    train_df = pd.read_csv(args.train_csv)
    class_counts = train_df["label"].value_counts().sort_index()

    plt.figure(figsize=(8, 4))
    class_counts.plot(kind="bar", color="#4C72B0")
    plt.title("Class Distribution (Train)")
    plt.ylabel("Count")
    plt.tight_layout()
    dist_path = os.path.join(args.output_dir, "class_distribution.png")
    plt.savefig(dist_path, dpi=150)
    plt.close()

    samples = []
    for label in class_counts.index:
        label_rows = train_df[train_df["label"] == label]
        samples.append(label_rows.sample(n=min(args.samples_per_class, len(label_rows))))

    sample_df = pd.concat(samples, ignore_index=True)

    num_cols = args.samples_per_class
    num_rows = len(class_counts)
    plt.figure(figsize=(num_cols * 3, num_rows * 3))

    for idx, row in sample_df.iterrows():
        img_path = row["image_path"]
        full_path = img_path
        if not os.path.isabs(img_path):
            full_path = os.path.join(args.images_dir, os.path.basename(img_path))

        image = plt.imread(full_path)
        ax = plt.subplot(num_rows, num_cols, idx + 1)
        ax.imshow(image)
        ax.set_title(row["label"])
        ax.axis("off")

    plt.tight_layout()
    grid_path = os.path.join(args.output_dir, "sample_grid.png")
    plt.savefig(grid_path, dpi=150)
    plt.close()

    print("Saved:", dist_path)
    print("Saved:", grid_path)


if __name__ == "__main__":
    main()
